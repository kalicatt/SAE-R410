<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.4.0/fonts/remixicon.css">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/destinations.css' %}">
    <title>Listes des Vols</title>
</head>
<body>
    <nav>
        <a class="nav__logo" href="{% url 'index' %}">Albert Airline</a>
        <ul class="nav__links">
            <li class="link"><a href="{% url 'index' %}">Home</a></li>
            <li class="link"><a href="{% url 'destinations' %}">Destinations</a></li>
        </ul>
        <div id="user-info"></div>
    </nav>
    <header class="section__container header__container">
        <h1 class="section__header">Listes des Vols</h1>
    </header>

    <section class="section__container flights__container">
        <h2 class="section__header">Depart des Vols</h2>
        <div class="flights_departure__header">
          <div>Numéro de vol</div>
          <div>Date de départ</div>
          <div>Destination</div>
          <div>Prix</div>
          <div>Sieges</div>
        </div>
        <div id="departures" class="flights__grid"></div>
    </section>

    <section class="section__container flights__container">
        <h2 class="section__header">Arriver des Vols</h2>
        <div class="flights_arrival__header">
          <div>Numéro de vol</div>
          <div>Date de départ</div>
          <div>Destination</div>
        </div>
        <div id="arrivals" class="flights__grid"></div>
    </section>

    <footer class="footer">
        <div class="section__container footer__container">
            <div class="footer__col">
                <h3>Albert Airline</h3>
                <p>
                    Projet cree dans le cadre de la SAE devcloud.
                </p>
            </div>
            <div class="footer__col">
                <h4>INFORMATION</h4>
                <a style="color: rgb(255, 255, 255);" href="{% url 'index' %}">Home</a><br>
                <a style="color: rgb(255, 255, 255);" href="{% url 'about' %}">About</a><br>
                <a style="color: rgb(255, 255, 255);" href="{% url 'offers' %}">Offers</a><br>
                <a style="color: rgb(255, 255, 255);" href="{% url 'seats' %}">Seats</a><br>
                <a style="color: rgb(255, 255, 255);" href="{% url 'destinations' %}">Destinations</a>
              </div>
              <div class="footer__col">
                <h4>CONTACT</h4>
                  <a style="color: rgb(255, 255, 255);" href="https://github.com/kalicatt">Github Servais Lucas</a><br>
                  <a style="color: rgb(255, 255, 255);" href="https://github.com/Fl0wwDev">Github Fradin Mahé</a><br>
                  <a style="color: rgb(255, 255, 255);" href="https://github.com/kalicatt">Github Antonio Christoper</a>
              </div>
            </div>
            <div class="section__container footer__bar">
              <p>Projet par : SERVAIS Lucas, FRADIN Mahé, ANTONIO Christopher</p>
            </div>
    </footer>

    <script type="module">
        import { connect, StringCodec } from '{% static "js/nats.js" %}';
    
        document.addEventListener('DOMContentLoaded', async function() {
            const user = JSON.parse(sessionStorage.getItem('user'));
            const userInfoDiv = document.getElementById('user-info');
    
            if (user) {
                userInfoDiv.innerHTML = `<span>Welcome, ${user.prenom} ${user.nom}</span>
                                          <a href="{% url 'profile' %}">Profile</a>
                                          <button id="logout-btn" class="btn">Logout</button>`;
            } else {
                userInfoDiv.innerHTML = `<button class="btn" onclick="window.location.href='{% url 'login' %}'">Login</button>`;
            }
    
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    sessionStorage.removeItem('user');
                    location.reload();  // Reload the page to update the UI
                });
            }
    
            console.log("Document loaded");
    
            let nc;
    
            try {
                nc = await connect({ servers: "ws://localhost:9222" });
                console.log("Connecté au serveur NATS");
    
                nc.closed().then(() => {
                    console.log("Connexion au serveur NATS fermée");
                });
    
                const sc = StringCodec();
    
                // Récupérer les départs
                const departuresResponse = await nc.request("get_departures", sc.encode(""), { timeout: 5000 });
                const departuresData = JSON.parse(sc.decode(departuresResponse.data));
    
                if (departuresData.status === 'success') {
                    const departuresContainer = document.getElementById('departures');
                    departuresData.data.forEach(departure => {
                        const flightDiv = document.createElement('div');
                        flightDiv.classList.add('flight');
                        flightDiv.innerHTML = `
                            <div class="flight__column"><a href="/flights/departure/${departure.id}/">${departure.flight_number}</a></div>
                            <div class="flight__column">${departure.departure_time}</div>
                            <div class="flight__column">${departure.destination}</div>
                            <div class="flight__column">${departure.prix}</div>
                            <div class="flight__column">${departure.sieges_disponible}</div>
                        `;
                        departuresContainer.appendChild(flightDiv);
                    });
                }
    
                // Récupérer les arrivées
                const arrivalsResponse = await nc.request("get_arrivals", sc.encode(""), { timeout: 5000 });
                const arrivalsData = JSON.parse(sc.decode(arrivalsResponse.data));
    
                if (arrivalsData.status === 'success') {
                    const arrivalsContainer = document.getElementById('arrivals');
                    arrivalsData.data.forEach(arrival => {
                        const flightDiv = document.createElement('div');
                        flightDiv.classList.add('flight');
                        flightDiv.innerHTML = `
                            <div class="flight__column">${arrival.flight_number}</div>
                            <div class="flight__column">${arrival.arrival_time}</div>
                            <div class="flight__column">${arrival.origin}</div>
                        `;
                        arrivalsContainer.appendChild(flightDiv);
                    });
                }
    
            } catch (err) {
                console.error(`Erreur de connexion au serveur NATS: ${err.message}`);
            }
        });
    </script>
    
    
</body>
</html>
